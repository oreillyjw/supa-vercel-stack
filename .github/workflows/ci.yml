name: âœ… CI
on:
    push:
        branches-ignore:
            - main
    pull_request:
        branches-ignore:
            - main
permissions:
    actions: write
    contents: read

jobs:
    lint:
        name: â¬£ ESLint
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: âŽ” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: ðŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: ðŸ”¬ Lint
              run: npm run lint

    typecheck:
        name: Ê¦ TypeScript
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: âŽ” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: ðŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: ðŸ”Ž Type check
              run: npm run typecheck --if-present

    vitest:
        name: âš¡ Vitest
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: âŽ” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: ðŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: âš¡ Run vitest
              run: npm run test -- --coverage

    playwright:
        name: ðŸŽ­ Playwright
        runs-on: ubuntu-latest
        needs: [lint, typecheck, vitest]
        steps:
              - name: ðŸ›‘ Cancel Previous Runs
                uses: styfle/cancel-workflow-action@0.11.0

              - name: â¬‡ï¸ Checkout repo
                uses: actions/checkout@v3

              - name: ðŸ”‘ Make envfile
                uses: SpicyPizza/create-envfile@v1.3
                with:
                    envkey_SESSION_SECRET: ${{ secrets.CI_SESSION_SECRET }}
                    envkey_SUPABASE_ANON_PUBLIC: ${{ secrets.CI_SUPABASE_ANON_PUBLIC }}
                    envkey_SUPABASE_SERVICE_ROLE: ${{ secrets.CI_SUPABASE_SERVICE_ROLE }}
                    envkey_SUPABASE_URL: ${{ secrets.CI_SUPABASE_URL }}
                    envkey_SERVER_URL: ${{ secrets.CI_SERVER_URL }}
                    envkey_DATABASE_URL: ${{ secrets.CI_DATABASE_URL }}
                    file_name: .env

              - name: âŽ” Setup node
                uses: actions/setup-node@v3
                with:
                    node-version: 22

              - name: ðŸ“¥ Download deps
                uses: bahmutov/npm-install@v1
                with:
                    useLockFile: false

              - name: âš™ï¸ Build
                run: npm run build

              - name: Setup Local Supabase
                uses: supabase/setup-cli@v1
                with:
                    version: latest
              - name: Setup Serverless Supabase
                uses: denoland/setup-deno@v2
                with:
                    deno-version: latest
              - name: Start Supabase
                run: supabase start

              - name: Wait for Supabase to be ready
                run: |
                    echo "Waiting for Supabase to be ready..."
                    timeout 10 bash -c 'until curl -f http://localhost:54321/auth/v1/health; do echo "Waiting for Supabase health check..."; sleep 2; done'
                    echo "Supabase is ready!"

              - name: Seed Supabase Database
                run: |
                    echo "Seeding database..."
                    npm run db:reset
                    echo "Database seeded successfully!"

              - name: Verify Database State
                run: |
                    echo "Checking database state..."
                    npx tsx -e "
                    import { getSupabaseAdmin } from './app/integrations/supabase/client';
                    (async () => {
                      const supabase = getSupabaseAdmin();
                      const { data, error, count } = await supabase.from('user').select('*', { count: 'exact', head: true });
                      console.log('User count:', count);
                      if (error) console.error('Database error:', error);
                      if (count === 0) {
                        console.error('No users found in database!');
                        process.exit(1);
                      }
                      console.log('Database verification passed!');
                    })();
                    "
                env:
                    SESSION_SECRET: ${{ secrets.CI_SESSION_SECRET }}
                    SUPABASE_ANON_PUBLIC: ${{ secrets.CI_SUPABASE_ANON_PUBLIC }}
                    SUPABASE_SERVICE_ROLE: ${{ secrets.CI_SUPABASE_SERVICE_ROLE }}
                    SUPABASE_URL: ${{ secrets.CI_SUPABASE_URL }}
                    SERVER_URL: ${{ secrets.CI_SERVER_URL }}
                    DATABASE_URL: ${{ secrets.CI_DATABASE_URL }}


              - name: ðŸŽ­ Install Playwright Browsers
                run: npx playwright install --with-deps chromium

              # uncomment if you really want to reset your testing database
              # - name: ðŸ›  Setup Database
              #   run: npx prisma migrate reset --force

              - name: ðŸŽ­ Playwright run
                run: npm run test:e2e:run
                env:
                    CI: true
