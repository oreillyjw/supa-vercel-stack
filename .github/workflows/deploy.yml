name: üöÄ Deploy
on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
permissions:
    actions: write
    contents: read

jobs:
    lint:
        name: ‚¨£ ESLint
        runs-on: ubuntu-latest
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3

            - name: ‚éî Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: üì• Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: üî¨ Lint
              run: npm run lint

    typecheck:
        name:  ¶ TypeScript
        runs-on: ubuntu-latest
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3

            - name: ‚éî Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: üì• Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: üîé Type check
              run: npm run typecheck --if-present

    vitest:
        name: ‚ö° Vitest
        runs-on: ubuntu-latest
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3

            - name: ‚éî Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: üì• Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: ‚ö° Run vitest
              run: npm run test -- --coverage

    playwright:
        name: üé≠ Playwright
        runs-on: ubuntu-latest
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3

            - name: üîë Make envfile
              uses: SpicyPizza/create-envfile@v1.3
              with:
                  envkey_SUPABASE_JWT_SECRET: ${{ secrets.CI_SUPABASE_JWT_SECRET }}
                  envkey_SUPABASE_ANON_KEY: ${{ secrets.CI_SUPABASE_ANON_KEY }}
                  envkey_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.CI_SUPABASE_SERVICE_ROLE_KEY }}
                  envkey_SUPABASE_URL: ${{ secrets.CI_SUPABASE_URL }}
                  envkey_SERVER_URL: ${{ secrets.CI_SERVER_URL }}
                  envkey_POSTGRES_PRISMA_URL: ${{ secrets.CI_POSTGRES_PRISMA_URL }}
                  file_name: .env

            - name: ‚éî Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 22

            - name: üì• Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: ‚öôÔ∏è Build
              run: npm run build

            - name: Setup Local Supabase
              uses: supabase/setup-cli@v1
              with:
                  version: latest
            - name: Setup Serverless Supabase
              uses: denoland/setup-deno@v2
              with:
                  deno-version: latest
            - name: Start Supabase
              run: supabase start

            - name: Wait for Supabase to be ready
              run: |
                  echo "Waiting for Supabase to be ready..."
                  timeout 60 bash -c 'until curl -f http://localhost:54321/auth/v1/health; do echo "Waiting for Supabase health check..."; sleep 2; done'
                  echo "Supabase is ready!"

            - name: Seed Supabase Database
              run: |
                  echo "Seeding database..."
                  npm run db:reset
                  echo "Database seeded successfully!"

            - name: Verify Database State
              run: |
                  echo "Checking database state..."
                  npx tsx -e "
                  import { getSupabaseAdmin } from './app/integrations/supabase/client';
                  (async () => {
                    const supabase = getSupabaseAdmin();
                    const { data, error, count } = await supabase.from('user').select('*', { count: 'exact', head: true });
                    console.log('User count:', count);
                    if (error) console.error('Database error:', error);
                    if (count === 0) {
                      console.error('No users found in database!');
                      process.exit(1);
                    }
                    console.log('Database verification passed!');
                  })();
                  "
              env:
                  SUPABASE_JWT_SECRET: ${{ secrets.CI_SUPABASE_JWT_SECRET }}
                  SUPABASE_ANON_KEY: ${{ secrets.CI_SUPABASE_ANON_KEY }}
                  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.CI_SUPABASE_SERVICE_ROLE_KEY }}
                  SUPABASE_URL: ${{ secrets.CI_SUPABASE_URL }}
                  SERVER_URL: ${{ secrets.CI_SERVER_URL }}
                  POSTGRES_PRISMA_URL: ${{ secrets.CI_POSTGRES_PRISMA_URL }}


            - name: üé≠ Install Playwright Browsers
              run: npx playwright install --with-deps chromium

            # uncomment if you really want to reset your testing database
            # - name: üõ† Setup Database
            #   run: npx prisma migrate reset --force

            - name: üé≠ Playwright run
              run: npm run test:e2e:run
              env:
                  CI: true

    deploy:
        name: üöÄ Deploy to Vercel
        runs-on: ubuntu-latest
        needs: [lint, typecheck, vitest, playwright]
        if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}

        env:
            SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
            SUPABASE_DB_PASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}
            SUPABASE_PROJECT_ID: ${{ secrets.PRODUCTION_PROJECT_ID }}

        steps:
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3

            - name: üóÑÔ∏è Setup Supabase CLI
              uses: supabase/setup-cli@v1
              with:
                  version: latest

            - name: üîó Link Supabase Project
              run: supabase link --project-ref $SUPABASE_PROJECT_ID

            - name: üóÉÔ∏è Push Database Migrations
              run: supabase db push

            - name: üöÄ Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  vercel-args: '--prod'
